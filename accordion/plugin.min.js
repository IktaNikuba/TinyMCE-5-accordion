tinymce.PluginManager.add('accordion', (editor, url) => {
  const openDialog = () => {
    return editor.windowManager.open({
      title: 'Accordion Settings',
      body: {
        type: 'panel',
        items: [
          {
            type: 'input',
            name: 'accordionTitle',
            label: 'Accordion Title'
          },
          {
            type: 'input',
            name: 'accordionContent',
            label: 'Accordion Content'
          }
        ]
      },
      buttons: [
        {
          type: 'cancel',
          text: 'Close'
        },
        {
          type: 'submit',
          text: 'Insert',
          primary: true
        }
      ],
      onSubmit: (api) => {
        const data = api.getData();
        editor.insertContent(`<details class="mce-accordion"><summary>${data.accordionTitle}</summary><div>${data.accordionContent}</div></details>`);
        api.close();
      }
    });
  };

  editor.ui.registry.addContextToolbar('accordion-toolbar', {
    predicate: (node) => node.tagName === 'DETAILS',
    items: 'toggleAccordion removeAccordion',
    position: 'node',
    scope: 'node'
  });

  editor.ui.registry.addButton('accordion', {
    icon: 'accordion',
    tooltip: 'Accordion',
    onAction: () => {
      if (editor.selection.getNode().tagName !== "SUMMARY") {
        openDialog();
      }
    }
  });

  editor.ui.registry.addButton('toggleAccordion', {
    icon: 'toggleAccordion',
    tooltip: 'Toggle Accordion',
    onAction: () => {
      const accordion = editor.selection.getNode().closest("details");
      if (accordion) {
        accordion.open = !accordion.open;
      }
    }
  });

  editor.ui.registry.addButton('removeAccordion', {
    icon: 'removeAccordion',
    tooltip: 'Remove Accordion',
    onAction: () => {
      const accordion = editor.selection.getNode().closest("details");
      if (accordion) {
        accordion.remove();
      }
    }
  });

  const icons = {
    accordion: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="12" y="7" width="10" height="2" rx="1" fill="black"/>
      <rect x="12" y="11" width="10" height="2" rx="1" fill="black"/>
      <rect x="12" y="15" width="6" height="2" rx="1" fill="black"/>
      <path fill-rule="evenodd" clip-rule="evenodd"
            d="M2.29289 7.29289C2.68342 6.90237 3.31658 6.90237 3.70711 7.29289L6 9.58579L8.29289 7.29289C8.68342 6.90237 9.31658 6.90237 9.70711 7.29289C10.0976 7.68342 10.0976 8.31658 9.70711 8.70711L6 12.4142L2.29289 8.70711C1.90237 8.31658 1.90237 7.68342 2.29289 7.29289Z"
            fill="black"/>
    </svg>`,

    toggleAccordion: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 15C12 14.4477 12.4477 14 13 14H19C19.5523 14 20 14.4477 20 15V15C20 15.5523 19.5523 16 19 16H13C12.4477 16 12 15.5523 12 15V15Z" fill="black"/>
        <path opacity="0.2" fill-rule="evenodd" clip-rule="evenodd" d="M4 15C4 14.4477 4.44772 14 5 14H11C11.5523 14 12 14.4477 12 15V15C12 15.5523 11.5523 16 11 16H5C4.44772 16 4 15.5523 4 15V15Z" fill="black"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 19C12 18.4477 12.4477 18 13 18H19C19.5523 18 20 18.4477 20 19V19C20 19.5523 19.5523 20 19 20H13C12.4477 20 12 19.5523 12 19V19Z" fill="black"/>
        <path opacity="0.2" fill-rule="evenodd" clip-rule="evenodd" d="M4 19C4 18.4477 4.44772 18 5 18H11C11.5523 18 12 18.4477 12 19V19C12 19.5523 11.5523 20 11 20H5C4.44772 20 4 19.5523 4 19V19Z" fill="black"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12.2929 7.29289C12.6834 6.90237 13.3166 6.90237 13.7071 7.29289L16 9.58579L18.2929 7.29289C18.6834 6.90237 19.3166 6.90237 19.7071 7.29289C20.0976 7.68342 20.0976 8.31658 19.7071 8.70711L16 12.4142L12.2929 8.70711C11.9024 8.31658 11.9024 7.68342 12.2929 7.29289Z" fill="black"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.29289 11.7071C3.90237 11.3166 3.90237 10.6834 4.29289 10.2929L6.58579 8L4.29289 5.70711C3.90237 5.31658 3.90237 4.68342 4.29289 4.29289C4.68342 3.90237 5.31658 3.90237 5.70711 4.29289L9.41421 8L5.70711 11.7071C5.31658 12.0976 4.68342 12.0976 4.29289 11.7071Z" fill="black"/>
    </svg>`,

    removeAccordion:
        `<svg width="24" height="24" viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <path
                d="M16,7 L19,7 C19.5522847,7 20,7.44771525 20,8 C20,8.55228475 19.5522847,9 19,9 L18,9 L18,18 C18,19.6568542 16.6568542,21 15,21 L9,21 C7.34314575,21 6,19.6568542 6,18 L6,9 L5,9 C4.44771525,9 4,8.55228475 4,8 C4,7.44771525 4.44771525,7 5,7 L8,7 L8,6 C8,4.34314575 9.34314575,3 11,3 L13,3 C14.6568542,3 16,4.34314575 16,6 L16,7 Z M14,7 L14,6 C14,5.44771525 13.5522847,5 13,5 L11,5 C10.4477153,5 10,5.44771525 10,6 L10,7 L14,7 Z M16,9 L8,9 L8,18 C8,18.5522847 8.44771525,19 9,19 L15,19 C15.5522847,19 16,18.5522847 16,18 L16,9 Z M9,12 C9,11.4477153 9.44771525,11 10,11 C10.5522847,11 11,11.4477153 11,12 L11,16 C11,16.5522847 10.5522847,17 10,17 C9.44771525,17 9,16.5522847 9,16 L9,12 Z M13,12 C13,11.4477153 13.4477153,11 14,11 C14.5522847,11 15,11.4477153 15,12 L15,16 C15,16.5522847 14.5522847,17 14,17 C13.4477153,17 13,16.5522847 13,16 L13,12 Z"
                fill="#000000" fill-rule="nonzero"></path>
          </g>
        </svg>`,
  };

  Object.keys(icons).forEach(key => {
    editor.ui.registry.addIcon(key, icons[key]);
  });

  return {
    getMetadata: () => {
      return {
        name: 'Accordion plugin',
      };
    }
  };
});